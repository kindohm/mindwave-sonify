<html>

<head>
  <title>Un:heard Resonance - Brainwave Sonifier</title>
  <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #222;
      color: #fff;
    }
  </style>
</head>

<body>
    <div class="container">
      <h1>Un:heard Resonance - Brainwave Sonifier</h1>
      <hr>
      <p>
        <button class="btn btn-default" id="toggle">Start/Stop</button>
        <button class="btn btn-default" id="simulate">Simulate Brainwaves</button>
        <button class="btn btn-default" id="changePatch">Change Patch</button>
      </p>

      <canvas id="delta" width="200" height="25"></canvas>
      <canvas id="theta" width="200" height="25"></canvas>
      <canvas id="loAlpha" width="200" height="25"></canvas>
      <canvas id="hiAlpha" width="200" height="25"></canvas>
      <canvas id="loBeta" width="200" height="25"></canvas>
      <canvas id="hiBeta" width="200" height="25"></canvas>
      <canvas id="loGamma" width="200" height="25"></canvas>
      <canvas id="midGamma" width="200" height="25"></canvas>

  </div>
  <script src="patch.js"></script>
  <script src="patch2.js"></script>
  <script src="voice.js"></script>
  <script src="graphs.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function (event) {

      let ws = new WebSocket('ws:/localhost:8080')
        , audioContext = new AudioContext()
        , toggle = document.getElementById('toggle')
        , simulateButton = document.getElementById('simulate')
        , changePatchButton = document.getElementById('changePatch')
        , playing = false
        , canvasNames = ['delta', 'theta', 'loAlpha', 'hiAlpha', 'hiBeta', 'loBeta', 'loGamma', 'midGamma']
        , canvasColors = ['#ff3333', '#33ff33', '#3333ff', '#33ffff', '#ff33ff', '#ffff33', '#cccccc', '#ffcc33']
        , graphs = new Graphs(document, canvasNames, canvasColors)
        , voice;

      toggle.addEventListener('click', function () {
        console.log('toggle play/stop');

        if (!playing) {
          console.log('not playing. creating a voice');
          voice = new Voice(audioContext);
          voice.start();
        } else {
          if (voice) voice.stop();
        }

        playing = !playing;
      });

      changePatchButton.addEventListener('click', () => {
        if (voice) voice.changePatch();
      });

      function sendModulation(modulation) {
        if (graphs) graphs.drawValues(modulation);
        if (voice) voice.modulate(modulation);
      }

      simulateButton.addEventListener('click', function () {

        setInterval(() => {

          var modulation = {
            delta: Math.random(),
            theta: Math.random(),
            loAlpha: Math.random(),
            hiAlpha: Math.random(),
            loBeta: Math.random(),
            hiBeta: Math.random(),
            loGamma: Math.random(),
            midGamma: Math.random()
          };

          sendModulation(modulation);

        }, 1000);

      });

      ws.onmessage = function (event) {
        try {
          console.log('websocket message', event.data);
          let message = JSON.parse(event.data);
          if (!message) return;

          var modulation = {
            delta: message.data.delta,
            theta: message.data.theta,
            loAlpha: message.data.loAlpha,
            hiAlpha: message.data.hiAlpha,
            loBeta: message.data.loBeta,
            hiBeta: message.data.hiBeta,
            loGamma: message.data.loGamma,
            midGamma: message.data.midGamma
          };

          sendModulation(modulation);
        }
        catch (err) {
          console.error('error on websocket message', err);
        }

      };
    });
  </script>


</body>

</html>