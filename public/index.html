<html>

<head>
  <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #222;
      color: #fff;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>NeuroSky Mindwave Sensor Sonification</h1>
    <hr>
    <p>
      <button class="btn btn-default" id="toggle">Start/Stop</button>
      <button class="btn btn-default" id="modulate">Random Modulate</button>
    </p>
  </div>
  <script>
    class Voice {
      constructor(audioContext, patch) {
        this.audioContext = audioContext;
        this.started = false;
        this.nodes = patch.nodes;
      }

      start() {
        if (this.started) {
          console.warn('tried to start a patch that has already been started.');
        }

        for (var i = 0; i < this.nodes.length; i++) {
          this.nodes[i].start(this.audioContext.currentTime);
        }
        this.started = true;
      }

      stop() {
        if (!this.started) return;
        for (var i = 0; i < this.nodes.length; i++) {
          this.nodes[i].stop(this.audioContext.currentTime);
        }
      }
    }

    class Patch {
      constructor(audioContext) {
        this.audioContext = audioContext;

        let osc1 = audioContext.createOscillator();
        osc1.connect(audioContext.destination);
        osc1.type = 'sawtooth';
        osc1.frequency.value = 400;

        let vibrato1 = audioContext.createGain()
        vibrato1.gain.value = 100;
        vibrato1.connect(osc1.detune);

        let lfo1 = audioContext.createOscillator()
        lfo1.connect(vibrato1)
        lfo1.frequency.value = 0.1;

        let vibrato2 = audioContext.createGain()
        vibrato2.gain.value = 100;
        vibrato2.connect(lfo1.detune);

        let lfo2 = audioContext.createOscillator()
        lfo2.connect(vibrato2);
        lfo2.frequency.value = 50;

        this.nodes = [osc1, lfo1, lfo2];
        this.osc1 = osc1;
        this.lfo1 = lfo1;
        this.lfo2 = lfo2;
        this.vibrato1 = vibrato1;

        this.modulate = this.modulate.bind(this);
      }

      modulate(params) {
        console.log('modulating', params);
        this.osc1.frequency.linearRampToValueAtTime(60 + 400 * params.x, this.audioContext.currentTime + 0.5);
        this.lfo1.frequency.linearRampToValueAtTime(200 * params.y, this.audioContext.currentTime + 0.5);
        this.lfo2.frequency.linearRampToValueAtTime(20 * params.y * params.x, this.audioContext.currentTime + 0.5);
        this.vibrato1.gain.linearRampToValueAtTime(params.x * 1000, this.audioContext.currentTime + 0.5)
      }
    }

    document.addEventListener("DOMContentLoaded", function (event) {

      let ws = new WebSocket('ws:/localhost:8080');
      let audioContext = new AudioContext();
      let toggle = document.getElementById('toggle');
      let modulate = document.getElementById('modulate');
      let voice, patch;
      let playing = false;

      toggle.addEventListener('click', function () {
        console.log('toggle play/stop');

        if (!playing) {
          console.log('not playing. creating a voice');
          patch = new Patch(audioContext);
          voice = new Voice(audioContext, patch);
          voice.start();
        } else {
          if (voice) voice.stop();
        }

        playing = !playing;
      });

      modulate.addEventListener('click', function () {
        if (!patch) return;
        patch.modulate({ x: Math.random(), y: Math.random() });
      });

      ws.onmessage = function (event) {
        try {
          console.log('websocket message', event.data);
          let message = JSON.parse(event.data);
          if (!patch) return;
          patch.modulate({ x: Math.random(), y: Math.random() });
        }
        catch (err) {
          console.error('error on websocket message', err);
        }

      };


    });
  </script>


</body>

</html>